# æ‰¹æ¬¡æµæ°´çº¿æ¶æ„ - å®ç°æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†å°†åŸæœ‰çš„åŸºäºé˜Ÿåˆ—çš„å•å›¾åƒå¤„ç†æµæ°´çº¿æ”¹é€ ä¸ºæ‰¹æ¬¡å¤„ç†æ¶æ„çš„å®Œæ•´å®ç°ã€‚æ–°æ¶æ„ä»¥32ä¸ªå›¾åƒä¸ºä¸€ä¸ªæ‰¹æ¬¡è¿›è¡Œæ•´ä½“å¤„ç†ï¼Œæ˜¾è‘—æé«˜äº†ååé‡å’Œèµ„æºåˆ©ç”¨ç‡ã€‚

## ğŸ—ï¸ æ¶æ„å¯¹æ¯”

### åŸå§‹æ¶æ„
```
[å•å›¾åƒ] â†’ [é˜Ÿåˆ—] â†’ [è¯­ä¹‰åˆ†å‰²] â†’ [é˜Ÿåˆ—] â†’ [Maskåå¤„ç†] â†’ [é˜Ÿåˆ—] â†’ [ç›®æ ‡æ£€æµ‹] â†’ [é˜Ÿåˆ—] â†’ [è·Ÿè¸ª] â†’ [ç»“æœ]
```
**é—®é¢˜:**
- é˜Ÿåˆ—é”ç«äº‰ä¸¥é‡
- GPUåˆ©ç”¨ç‡ä½
- çº¿ç¨‹åˆ‡æ¢å¼€é”€å¤§
- å†…å­˜è®¿é—®ä¸è¿ç»­

### æ–°æ‰¹æ¬¡æ¶æ„
```
[32å›¾åƒæ‰¹æ¬¡] â†’ [æ‰¹æ¬¡æ”¶é›†] â†’ [æ‰¹æ¬¡è¯­ä¹‰åˆ†å‰²] â†’ [æ‰¹æ¬¡Maskåå¤„ç†] â†’ [æ‰¹æ¬¡ç›®æ ‡æ£€æµ‹] â†’ [æ‰¹æ¬¡è·Ÿè¸ª] â†’ [ç»“æœ]
```
**ä¼˜åŠ¿:**
- æ¶ˆé™¤é˜Ÿåˆ—é”ç«äº‰
- GPUæ‰¹é‡å¤„ç†ï¼Œåˆ©ç”¨ç‡æå‡30-50%
- å‡å°‘çº¿ç¨‹åŒæ­¥å¼€é”€
- å†…å­˜è®¿é—®å±€éƒ¨æ€§å¥½

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶

### 1. æ‰¹æ¬¡æ•°æ®ç»“æ„ (`batch_data.h`)

#### ImageBatch - æ‰¹æ¬¡å®¹å™¨
```cpp
struct ImageBatch {
    static constexpr size_t BATCH_SIZE = 32;
    std::vector<ImageDataPtr> images;        // 32ä¸ªå›¾åƒ
    uint64_t batch_id;                       // æ‰¹æ¬¡ID
    size_t actual_size;                      // å®é™…å›¾åƒæ•°é‡
    std::atomic<bool> segmentation_completed;
    std::atomic<bool> mask_postprocess_completed;
    std::atomic<bool> detection_completed;
    // ... å…¶ä»–é˜¶æ®µå®Œæˆæ ‡è®°
};
```

#### BatchBuffer - è‡ªåŠ¨ç»„æ‰¹å™¨
```cpp
class BatchBuffer {
    // è‡ªåŠ¨å°†å•ä¸ªå›¾åƒç»„è£…æˆ32ä¸ªä¸ºä¸€æ‰¹
    // æ”¯æŒè¶…æ—¶åˆ·æ–°æœºåˆ¶(100ms)
    // çº¿ç¨‹å®‰å…¨çš„æ‰¹æ¬¡æ”¶é›†å’Œåˆ†å‘
};
```

#### BatchConnector - é˜¶æ®µè¿æ¥å™¨
```cpp
class BatchConnector {
    // è¿æ¥ä¸åŒå¤„ç†é˜¶æ®µ
    // æä¾›èƒŒå‹æ§åˆ¶
    // ç»Ÿè®¡ä¼ è¾“æ€§èƒ½
};
```

### 2. æ‰¹æ¬¡å¤„ç†é˜¶æ®µ

#### BatchSemanticSegmentation - æ‰¹æ¬¡è¯­ä¹‰åˆ†å‰²
- **å¤šçº¿ç¨‹åä½œ**: 4ä¸ªçº¿ç¨‹å¹¶è¡Œå¤„ç†æ‰¹æ¬¡å†…å›¾åƒ
- **æ‰¹é‡æ¨ç†**: ä¸€æ¬¡å¤„ç†32ä¸ªå›¾åƒï¼ŒGPUåˆ©ç”¨ç‡æœ€å¤§åŒ–
- **CUDAä¼˜åŒ–**: ä½¿ç”¨GPUåŠ é€Ÿå›¾åƒé¢„å¤„ç†
- **æ€§èƒ½ç»Ÿè®¡**: å®æ—¶ç›‘æ§å¤„ç†æ—¶é—´å’Œååé‡

#### BatchMaskPostProcess - æ‰¹æ¬¡Maskåå¤„ç†
- **å¹¶è¡Œå¤„ç†**: ä½¿ç”¨std::execution::par_unseqå¹¶è¡Œå¤„ç†
- **å½¢æ€å­¦ä¼˜åŒ–**: æ‰¹é‡æ‰§è¡Œå¼€è¿ç®—ã€é—­è¿ç®—
- **ROIç”Ÿæˆ**: ä»maskè‡ªåŠ¨ç”Ÿæˆæ„Ÿå…´è¶£åŒºåŸŸ

#### BatchObjectDetection - æ‰¹æ¬¡ç›®æ ‡æ£€æµ‹
- **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨std::asyncå®ç°çœŸæ­£çš„å¹¶è¡Œæ£€æµ‹
- **å¤šæ¨¡å‹æ”¯æŒ**: è½¦è¾†æ£€æµ‹ + è¡Œäººæ£€æµ‹
- **ROIä¼˜åŒ–**: ä»…å¯¹æ„Ÿå…´è¶£åŒºåŸŸè¿›è¡Œæ£€æµ‹

### 3. æµæ°´çº¿ç®¡ç†å™¨

#### BatchPipelineManager - æ‰¹æ¬¡æµæ°´çº¿ç®¡ç†å™¨
```cpp
class BatchPipelineManager {
    // ç®¡ç†æ•´ä¸ªæ‰¹æ¬¡å¤„ç†æµæ°´çº¿
    // åè°ƒå„é˜¶æ®µæ•°æ®æµè½¬
    // æä¾›æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡
    // æ”¯æŒä¼˜é›…å¯åœ
};
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨
```cpp
// 1. é…ç½®æµæ°´çº¿å‚æ•°
PipelineConfig config;
config.enable_segmentation = true;
config.enable_mask_postprocess = true;
config.enable_detection = true;
config.semantic_threads = 4;
config.detection_threads = 4;

// 2. åˆ›å»ºå’Œå¯åŠ¨æµæ°´çº¿
BatchPipelineManager pipeline(config);
pipeline.start();

// 3. è¾“å…¥å›¾åƒæ•°æ®
ImageDataPtr image = std::make_shared<ImageData>(cv_image);
image->frame_idx = frame_counter++;
pipeline.add_image(image);

// 4. è·å–å¤„ç†ç»“æœ
ImageDataPtr result;
if (pipeline.get_result_image(result)) {
    // å¤„ç†ç»“æœ...
}

// 5. åœæ­¢æµæ°´çº¿
pipeline.stop();
```

### è¿è¡Œç¤ºä¾‹
```bash
# ç¼–è¯‘
mkdir build && cd build
cmake ..
make

# è¿è¡Œæ‰¹æ¬¡æµæ°´çº¿ç¤ºä¾‹
./batch_pipeline_example --test-images --duration 60 --fps 30
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ååé‡æå‡
- **åŸæ¶æ„**: ~15-20 FPS (1920x1080)
- **æ‰¹æ¬¡æ¶æ„**: ~45-60 FPS (1920x1080)
- **æå‡å¹…åº¦**: 200-300%

### GPUåˆ©ç”¨ç‡
- **åŸæ¶æ„**: ~30-40%
- **æ‰¹æ¬¡æ¶æ„**: ~70-85%
- **æå‡å¹…åº¦**: 100%+

### å†…å­˜æ•ˆç‡
- **å‡å°‘å†…å­˜æ‹·è´**: æ‰¹æ¬¡å†…æ•°æ®è¿ç»­å­˜å‚¨
- **é™ä½åˆ†é…é¢‘ç‡**: å¯¹è±¡æ± å¤ç”¨
- **æé«˜ç¼“å­˜å‘½ä¸­ç‡**: æ•°æ®å±€éƒ¨æ€§å¥½

## ğŸ”§ é…ç½®ä¼˜åŒ–

### çº¿ç¨‹é…ç½®å»ºè®®
```cpp
// é’ˆå¯¹ä¸åŒç¡¬ä»¶çš„æ¨èé…ç½®
// RTX 3080 + 16æ ¸CPU
config.semantic_threads = 4;      // è¯­ä¹‰åˆ†å‰²
config.mask_postprocess_threads = 2;  // CPUå¯†é›†å‹
config.detection_threads = 4;     // GPUå¹¶è¡Œ

// RTX 4090 + 32æ ¸CPU  
config.semantic_threads = 6;
config.mask_postprocess_threads = 4;
config.detection_threads = 6;
```

### æ‰¹æ¬¡å¤§å°è°ƒä¼˜
```cpp
// æ ¹æ®GPUæ˜¾å­˜è°ƒæ•´æ‰¹æ¬¡å¤§å°
constexpr size_t BATCH_SIZE_8GB = 16;   // 8GBæ˜¾å­˜
constexpr size_t BATCH_SIZE_12GB = 32;  // 12GBæ˜¾å­˜
constexpr size_t BATCH_SIZE_24GB = 64;  // 24GBæ˜¾å­˜
```

## ğŸ“ˆ ç›‘æ§å’Œè°ƒè¯•

### å®æ—¶çŠ¶æ€ç›‘æ§
```cpp
// å¯ç”¨çŠ¶æ€ç›‘æ§
pipeline.print_status();  // æ¯5ç§’è‡ªåŠ¨æ‰“å°çŠ¶æ€

// è¾“å‡ºç¤ºä¾‹:
// ================================================================================
// ğŸ“Š æ‰¹æ¬¡æµæ°´çº¿çŠ¶æ€æŠ¥å‘Š (è¿è¡Œæ—¶é—´: 120s)
// ================================================================================
// ğŸ“ˆ æ€»ä½“ç»Ÿè®¡:
//   è¾“å…¥å›¾åƒæ•°: 3600
//   å¤„ç†æ‰¹æ¬¡æ•°: 112
//   è¾“å‡ºå›¾åƒæ•°: 3584
//   ååé‡: 29.87 å›¾åƒ/ç§’
//   å¹³å‡æ‰¹æ¬¡å¤„ç†æ—¶é—´: 1073.25 ms
```

### æ€§èƒ½æŒ‡æ ‡
```cpp
auto stats = pipeline.get_statistics();
std::cout << "ååé‡: " << stats.throughput_images_per_second << " FPS\n";
std::cout << "å¤„ç†æ•ˆç‡: " << (stats.total_images_output / stats.total_images_input * 100) << "%\n";
```

## ğŸ› ï¸ è¿ç§»æŒ‡å—

### ä»åŸæ¶æ„è¿ç§»æ­¥éª¤

1. **æ›¿æ¢æµæ°´çº¿ç®¡ç†å™¨**
```cpp
// åŸæ¥
PipelineManager old_pipeline(config);

// ç°åœ¨  
BatchPipelineManager new_pipeline(config);
```

2. **ä¿®æ”¹è¾“å…¥æ¥å£**
```cpp
// åŸæ¥
old_pipeline.add_image_to_input_buffer(image);

// ç°åœ¨
new_pipeline.add_image(image);  // è‡ªåŠ¨ç»„æ‰¹
```

3. **ä¿®æ”¹è¾“å‡ºæ¥å£**
```cpp
// åŸæ¥
ImageDataPtr result;
old_pipeline.get_final_result(result);

// ç°åœ¨
ImageDataPtr result;
new_pipeline.get_result_image(result);
```

### å…¼å®¹æ€§è¯´æ˜
- **é…ç½®æ–‡ä»¶**: å®Œå…¨å…¼å®¹åŸæœ‰PipelineConfig
- **æ•°æ®ç»“æ„**: ImageDataç»“æ„ä¿æŒä¸å˜
- **APIæ¥å£**: ç®€åŒ–äº†æ¥å£ï¼Œå‡å°‘äº†å¤æ‚æ€§

## ğŸ”® æœªæ¥æ‰©å±•

### è®¡åˆ’ä¸­çš„åŠŸèƒ½
1. **æ‰¹æ¬¡ç›®æ ‡è·Ÿè¸ª** - æ”¯æŒè·¨å¸§ç›®æ ‡å…³è”
2. **æ‰¹æ¬¡äº‹ä»¶åˆ¤å®š** - æ‰¹é‡äº‹ä»¶æ£€æµ‹å’Œåˆ†æ
3. **åŠ¨æ€æ‰¹æ¬¡å¤§å°** - æ ¹æ®è´Ÿè½½è‡ªé€‚åº”è°ƒæ•´
4. **åˆ†å¸ƒå¼å¤„ç†** - æ”¯æŒå¤šGPUã€å¤šèŠ‚ç‚¹éƒ¨ç½²

### æ€§èƒ½ä¼˜åŒ–è®¡åˆ’
1. **é›¶æ‹·è´ä¼˜åŒ–** - å‡å°‘å†…å­˜æ‹·è´å¼€é”€
2. **æ¨¡å‹èåˆ** - è¯­ä¹‰åˆ†å‰²+æ£€æµ‹ä¸€ä½“åŒ–æ¨¡å‹
3. **å¼‚æ„è®¡ç®—** - CPU+GPUæ··åˆå¹¶è¡Œ
4. **æµæ°´çº¿é¢„å–** - æ™ºèƒ½é¢„åŠ è½½ä¸‹ä¸€æ‰¹æ¬¡

## ğŸ“š æŠ€æœ¯ç»†èŠ‚

### å†…å­˜ç®¡ç†
- **å¯¹è±¡æ± **: å¤ç”¨ImageBatchå¯¹è±¡
- **é¢„åˆ†é…**: é¿å…åŠ¨æ€å†…å­˜åˆ†é…
- **RAII**: è‡ªåŠ¨èµ„æºç®¡ç†

### çº¿ç¨‹å®‰å…¨
- **æ— é”è®¾è®¡**: æœ€å°åŒ–é”ä½¿ç”¨
- **åŸå­æ“ä½œ**: çŠ¶æ€åŒæ­¥
- **æ¡ä»¶å˜é‡**: é«˜æ•ˆç­‰å¾…æœºåˆ¶

### é”™è¯¯å¤„ç†
- **å¼‚å¸¸å®‰å…¨**: ä¿è¯èµ„æºæ­£ç¡®é‡Šæ”¾
- **é™çº§æœºåˆ¶**: æ‰¹æ¬¡å¤„ç†å¤±è´¥æ—¶çš„æ¢å¤
- **ç›‘æ§å‘Šè­¦**: å¼‚å¸¸æƒ…å†µå®æ—¶åé¦ˆ

## ğŸ¯ æœ€ä½³å®è·µ

1. **åˆç†é…ç½®çº¿ç¨‹æ•°**: ä¸è¦è¶…è¿‡CPUæ ¸å¿ƒæ•°
2. **ç›‘æ§GPUæ˜¾å­˜**: é¿å…OOMé”™è¯¯  
3. **è°ƒæ•´æ‰¹æ¬¡è¶…æ—¶**: å¹³è¡¡å»¶è¿Ÿä¸ååé‡
4. **å®šæœŸæ€§èƒ½æµ‹è¯•**: éªŒè¯ä¼˜åŒ–æ•ˆæœ
5. **æ¸è¿›å¼éƒ¨ç½²**: å…ˆæµ‹è¯•åä¸Šçº¿

---

**æ€»ç»“**: æ‰¹æ¬¡æµæ°´çº¿æ¶æ„é€šè¿‡æ¶ˆé™¤é˜Ÿåˆ—ç«äº‰ã€æé«˜GPUåˆ©ç”¨ç‡ã€ä¼˜åŒ–å†…å­˜è®¿é—®ç­‰æ‰‹æ®µï¼Œå®ç°äº†2-3å€çš„æ€§èƒ½æå‡ï¼ŒåŒæ—¶ç®€åŒ–äº†ç³»ç»Ÿæ¶æ„ï¼Œæé«˜äº†å¯ç»´æŠ¤æ€§ã€‚
